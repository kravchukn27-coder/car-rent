# Booking Car Scout — Спецификация

## Версионность разработки

Текущая версия спецификации: `v1.2.3`

Правила ведения:

- каждая заметная доработка фиксируется новой записью в истории ниже
- формат версии: `MAJOR.MINOR.PATCH`
  - `MAJOR` — несовместимые изменения логики/API
  - `MINOR` — новые функции без поломки совместимости
  - `PATCH` — исправления багов/стабильности без изменения контракта
- для каждой версии указывать:
  - дату
  - короткий список изменений
  - статус (`planned` / `in-progress` / `done`)

### История версий (Changelog)

> В этом разделе фиксируются **изменения поведения и логики** сервиса. Детали визуального оформления клиентского UI сознательно не описываются.

#### v1.2.3 — 2026-02-24 — done

- стабилизировано поведение гибкого поиска по датам: календарная сетка всегда формируется как фиксированное окно в 42 ячейки (6 недель), чтобы исключить артефакты в отдельных месяцах
- устранены проблемы с обрезанием текстов и выбранных окон в гибком режиме (все выбранные окна и поясняющие тексты всегда доступны пользователю)

#### v1.2.2 — 2026-02-24 — done

- уточнена логика выделения диапазонов в гибком режиме: чётко разделены даты старта, конца и промежуточные дни окна
- фильтр «Время выдачи» переведён на динамические значения, формируемые из фактических полей результатов (`time` / `pickupTime`), что корректно поддерживает произвольные часы из гибкого поиска
- порядок действий в панели управления приведён к следующему: сначала чтение последнего результата, затем запуск нового поиска

#### v1.2.1 — 2026-02-24 — done

- стабилизирована работа «обычного» режима с выбором диапазона дат: синхронизация выбранных дат и автоматический переход между месяцами работают предсказуемо
- исправлены граничные кейсы при расчёте доступныx окон для `rentDays = 6` и `7` дней

#### v1.2.0 — 2026-02-24 — done

- добавлены два режима работы поиска:
  - **Обычный режим** — поиск по непрерывному диапазону дат (`startDate`–`endDate`) с ограничением окна максимум 7 дней
  - **Гибкий режим** — поиск по набору отдельных дат старта (`pickupDates`) и двум часам выдачи (`pickupTimes`)
- в гибком режиме:
  - поддерживается выбор до `6` дат старта (`pickupDates`)
  - реализованы пресеты для быстрого выбора дат (например, «все выходные», «все пятницы»)
  - добавлена передача двух пользовательских временных окон выдачи (`08:00..18:00`) через `pickupTimes`
- в обычном режиме:
  - восстановлена логика окна поиска `1..7` дней независимо от `rentDays`
  - запрещён выбор прошедших дат
- стабилизирован runtime:
  - отключён нестабильный headless-путь из-за регрессий
  - возвращён параллельный поиск по вкладкам браузера (по умолчанию `4`, параметр `PARALLEL_TABS`)
- улучшена работа с капчей:
  - скрипт сигнализирует о необходимости ручной проверки (через события и `/api/progress`)
  - после успешного прохождения капчи поиск продолжается без перезапуска

#### v1.1.3 — 2026-02-24 — done

- текущий билд зафиксирован как рабочий baseline для дальнейших изменений
- результат «самое дешёвое окно» стал навигационным объектом: можно перейти к соответствующему окну/времени в списке результатов
- стабилизирован ввод `rentDays` с клавиатуры при сохранении ограничений `1..7`

#### v1.1.2 — 2026-02-24 — done

- ужесточено ограничение по количеству машин на локацию: сохраняется только 1 самая дешёвая машина вместо 2
- цель изменения — ускорить прогон и упростить итоговую выдачу для анализа

#### v1.1.1 — 2026-02-24 — done

- подтверждён hotfix по кейсу пустой выдачи: окно `24–26` корректно даёт результат на `16:00`
- стабилизирована логика детекции пустой выдачи (`cards-first`, консервативный `no-cars`)
- добавлен best-effort путь после soft-timeout и ослабление supplier-фильтра, если UI-фильтр не применился
- известное ограничение: в разреженных окнах (когда доступно только одно время) возможен увеличенный runtime

#### v1.1.0 — 2026-02-21 — done

- внедрены шаг 1 и шаг 2 recovery‑плана по логике дат и окон (без изменения контракта API)
- добавлен серверный `GET /api/progress` для мониторинга выполнения поиска
- в модель прогресса добавлены проценты и оценка оставшегося времени (ETA), рассчитываемые по завершённым job
- зафиксированы рабочие варианты конфигурации (`R5a`, `R5c`), откатан неудачный (`R5b`) из‑за регрессии производительности

#### v1.0.0 — 2026-02-21 — done

- восстановлена базовая рабочая структура проекта (`set_location.js`, `server.js`, `public/index.html`)
- описана архитектура, API и сценарии запуска
- добавлен единый файл спецификации в корень проекта

## Назначение

Сервис для поиска выгодной аренды авто на `cars.booking.com` по заданному диапазону дат и длительности аренды, с выводом результатов в UI и в файлы (`results.json`, `results.csv`).

## Состав проекта

- `set_location.js` — основной Playwright-скрипт поиска.
- `server.js` — локальный HTTP-сервер (Express) + API для запуска и чтения результатов.
- `public/index.html` — клиентский UI.
- `results.json` — структурированный результат поиска.
- `results.csv` — табличный экспорт.

## Режимы запуска

- UI:
  - `npm run ui` или `npm start`
  - открывает локальный сервер на `http://127.0.0.1:3000` (или следующий свободный порт до `3010`)
- CLI:
  - `npm run run` (скрипт напрямую)
  - `node set_location.js <startDate?> <rentDays?>`

## Параметры поиска

- `startDate` — дата начала окна поиска (YYYY-MM-DD).
- `endDate` — дата конца окна поиска.
- `rentDays` — длительность аренды (1..7).

На сервере окно поиска ограничено максимум 7 днями.

## Бизнес-логика поиска

- По каждому дню окна и по каждому времени выдачи формируются запросы к Booking.
- Из карточек результатов извлекаются:
  - поставщик
  - локация
  - модель
  - цена
- Применяются фильтры по нужным поставщикам/локациям.
- Для каждого окна выбираются минимальные цены и сохраняются результаты.
- На каждую локацию сохраняется только 1 самая дешёвая машина.

## API

### `POST /api/run`

Запускает поиск.

Тело:

```json
{
  "startDate": "2026-03-18",
  "endDate": "2026-03-20",
  "rentDays": 1
}
```

Ответ:

- `200` + `{ "ok": true }` при успешном завершении
- `500` + ошибка при проблемах запуска/выполнения

### `GET /api/results`

Возвращает содержимое `results.json`.

### `GET *`

Возвращает `public/index.html` (SPA fallback).

## UI-функции

- выбор дат и длительности аренды
- запуск нового поиска
- загрузка последних результатов
- сортировка и фильтрация карточек в интерфейсе

## Технические ограничения

- Сервер слушает только localhost (`127.0.0.1`), не предназначен для внешнего доступа.
- При повторном запуске предыдущий процесс поиска останавливается (`SIGTERM`).
- Если `results.json` отсутствует, API возвращает `404`.

## Зависимости

- runtime: `express`
- dev/runtime tools: `playwright`, `nodemon`

## Минимальный smoke-check

1. `npm run ui`
2. открыть ссылку из терминала
3. нажать «Запустить поиск»
4. убедиться, что после завершения обновились:
   - `results.json`
   - `results.csv`
