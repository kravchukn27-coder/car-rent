# Booking Car Scout — Спецификация

## Версионность разработки

Текущая версия спецификации: `v1.2.3`

Правила ведения:

- каждая заметная доработка фиксируется новой записью в истории ниже
- формат версии: `MAJOR.MINOR.PATCH`
  - `MAJOR` — несовместимые изменения логики/API
  - `MINOR` — новые функции без поломки совместимости
  - `PATCH` — исправления багов/стабильности без изменения контракта
- для каждой версии указывать:
  - дату
  - короткий список изменений
  - статус (`planned` / `in-progress` / `done`)

### История версий (Changelog)

#### v1.2.3 — 2026-02-24 — done

- доработан layout `Гибкого` режима: календарь центрирован в синей панели без изменения пропорций, устранены визуальные сдвиги и «вылезание» за рамку
- исправлено переполнение контента в `Гибком` блоке: нижние пояснения и выбранные окна всегда отображаются полностью, без скрытия из-за жёсткой высоты
- стабилизирована отрисовка месяцев в `Гибком` календаре: используется фиксированная сетка `6x7` (42 ячейки), что убирает «ломаный» вид в отдельных месяцах (например, март)

#### v1.2.2 — 2026-02-24 — done

- переработан визуальный стиль календаря в `Гибком` режиме: добавлена компактная карточка, центрирование блока, увеличен размер дней после калибровки и выровнен внешний вид с `Обычным` режимом
- обновлена логика подсветки `Гибкого` календаря: дата старта и дата конца окна отмечаются синим акцентом, промежуточные дни окна выделяются отдельным цветом
- в панели действий переставлены кнопки: сначала `Загрузить последние результаты`, затем `Запустить поиск`
- фильтр `Время выдачи` переведён на динамические значения из фактических результатов (`time`/`pickupTime`), что корректно поддерживает произвольные часы из `Гибкого` поиска

#### v1.2.1 — 2026-02-24 — done

- доведён UX обычного режима с двумя календарями (`Начало аренды` / `Конец аренды`), стабилизирована синхронизация выбранных дат и автоподстройка месяца календаря конца
- исправлены граничные кейсы окна дат: устранены артефакты подсветки при смене старта, восстановлена корректная работа диапазона для длительности аренды `6` и `7` дней
- обновлена визуальная логика подсветки: в календаре начала выделяется только дата старта, в календаре конца выделяются доступные даты, середина диапазона и дата конца

#### v1.2.0 — 2026-02-24 — done

- переработан UI поиска: добавлены режимы `Обычный` и `Гибкий`, новые календари, пресеты и улучшенная визуализация прогресса
- в `Гибком` режиме добавлен выбор до `6` окон поиска, поддержка `pickupDates`, пресеты (`выходные`, `пятницы`) и выбор двух пользовательских временных окон `08:00..18:00`
- в `Обычном` режиме восстановлена логика окна поиска `1..7` дней независимо от `rentDays`, добавлен календарный выбор диапазона и запрет прошедших дат
- стабилизирован runtime: отключён headless-путь из-за регрессий, возвращён параллельный поиск по вкладкам (по умолчанию `4`, configurable)
- улучшен UX капчи: уведомления в прогрессе + модальное окно с подтверждением пользователя

#### v1.1.3 — 2026-02-24 — done

- зафиксирован текущий билд как рабочий baseline
- UI: «Самое дешёвое окно» сделано интерактивным элементом (переход к нужному окну/времени, подсветка карточки)
- UI: удалено дублирование кнопки, сохранён один сценарий навигации
- UI: поле длительности аренды стабилизировано для ввода с клавиатуры при сохранении ограничений `1..7`

#### v1.1.2 — 2026-02-24 — done

- изменено ограничение выдачи: на каждую локацию сохраняется только 1 самая дешёвая машина (вместо 2)
- цель изменения: ускорить прогон и упростить итоговую выдачу

#### v1.1.1 — 2026-02-24 — done

- подтверждён hotfix по кейсу пустой выдачи: окно `24-26` корректно даёт результат на `16:00`
- стабилизирована логика детекции пустой выдачи (`cards-first`, консервативный `no-cars`)
- добавлен best-effort путь после soft-timeout и ослабление supplier-фильтра, если UI-фильтр не применился
- известное ограничение: в разреженных окнах (когда доступно только одно время) возможен увеличенный runtime

#### v1.1.0 — 2026-02-21 — done

- шаг 1 и шаг 2 recovery-плана внедрены и подтверждены пользователем (UI-тексты + корректная логика дат/окна)
- добавлен серверный `GET /api/progress` без изменения стабильной модели `POST /api/run`
- в UI добавлен progress bar и ETA, расчёт прогресса улучшен по завершённым job
- текущий билд зафиксирован как рабочий и корректный
- подшаг `R5a` подтверждён как рабочий (время прогона ~58.5s)
- подшаг `R5b` откатан из-за регрессии производительности и стабильности
- подшаг `R5c` подтверждён как рабочий (время сопоставимо с `R5a`, без новых регрессий)

#### v1.0.0 — 2026-02-21 — done

- восстановлена базовая рабочая структура проекта (`set_location.js`, `server.js`, `public/index.html`)
- описана текущая архитектура, API и сценарии запуска
- добавлен единый файл спецификации в корень проекта

## Назначение

Сервис для поиска выгодной аренды авто на `cars.booking.com` по заданному диапазону дат и длительности аренды, с выводом результатов в UI и в файлы (`results.json`, `results.csv`).

## Состав проекта

- `set_location.js` — основной Playwright-скрипт поиска.
- `server.js` — локальный HTTP-сервер (Express) + API для запуска и чтения результатов.
- `public/index.html` — клиентский UI.
- `results.json` — структурированный результат поиска.
- `results.csv` — табличный экспорт.

## Режимы запуска

- UI:
  - `npm run ui` или `npm start`
  - открывает локальный сервер на `http://127.0.0.1:3000` (или следующий свободный порт до `3010`)
- CLI:
  - `npm run run` (скрипт напрямую)
  - `node set_location.js <startDate?> <rentDays?>`

## Параметры поиска

- `startDate` — дата начала окна поиска (YYYY-MM-DD).
- `endDate` — дата конца окна поиска.
- `rentDays` — длительность аренды (1..7).

На сервере окно поиска ограничено максимум 7 днями.

## Бизнес-логика поиска

- По каждому дню окна и по каждому времени выдачи формируются запросы к Booking.
- Из карточек результатов извлекаются:
  - поставщик
  - локация
  - модель
  - цена
- Применяются фильтры по нужным поставщикам/локациям.
- Для каждого окна выбираются минимальные цены и сохраняются результаты.
- На каждую локацию сохраняется только 1 самая дешёвая машина.

## API

### `POST /api/run`

Запускает поиск.

Тело:

```json
{
  "startDate": "2026-03-18",
  "endDate": "2026-03-20",
  "rentDays": 1
}
```

Ответ:

- `200` + `{ "ok": true }` при успешном завершении
- `500` + ошибка при проблемах запуска/выполнения

### `GET /api/results`

Возвращает содержимое `results.json`.

### `GET *`

Возвращает `public/index.html` (SPA fallback).

## UI-функции

- выбор дат и длительности аренды
- запуск нового поиска
- загрузка последних результатов
- сортировка и фильтрация карточек в интерфейсе

## Технические ограничения

- Сервер слушает только localhost (`127.0.0.1`), не предназначен для внешнего доступа.
- При повторном запуске предыдущий процесс поиска останавливается (`SIGTERM`).
- Если `results.json` отсутствует, API возвращает `404`.

## Зависимости

- runtime: `express`
- dev/runtime tools: `playwright`, `nodemon`

## Минимальный smoke-check

1. `npm run ui`
2. открыть ссылку из терминала
3. нажать «Запустить поиск»
4. убедиться, что после завершения обновились:
   - `results.json`
   - `results.csv`
