# Booking Car Scout — Спецификация

> Текущая версия спецификации и полная история изменений описаны в файле `VERSIONS.md`.

## Назначение

Сервис для поиска выгодной аренды авто на `cars.booking.com` по заданному диапазону дат и длительности аренды, с выводом результатов в UI и в файлы (`results.json`, `results.csv`).

## Состав проекта

- `set_location.js` — основной Playwright-скрипт поиска.
- `server.js` — локальный HTTP-сервер (Express) + API для запуска и чтения результатов.
- `public/index.html` — клиентский UI.
- `results.json` — структурированный результат поиска.
- `results.csv` — табличный экспорт.

## Режимы запуска

- UI:
  - `npm run ui` или `npm start`
  - открывает локальный сервер на `http://127.0.0.1:3000` (или следующий свободный порт до `3010`)
- CLI:
  - `npm run run` (скрипт напрямую)
  - `node set_location.js <startDate?> <rentDays?>`

## Параметры поиска

- `startDate` — дата начала окна поиска (YYYY-MM-DD).
- `endDate` — дата конца окна поиска.
- `rentDays` — длительность аренды (1..7).

На сервере окно поиска ограничено максимум 7 днями.

## Бизнес-логика поиска

В проекте есть два режима поиска:

- **Обычный режим (диапазон дат)**:
  - пользователь выбирает календарное окно (`startDate`–`endDate`) и базовую длительность аренды `rentDays` (1..7);
  - для каждой стартовой даты внутри окна перебираются длительности: `rentDays`, `rentDays+1`, `rentDays+2`, `rentDays+3`;
  - комбинированная длительность не может превышать 7 дней и не может выходить за пределы выбранного окна;
  - для всех допустимых комбинаций (дата старта × длительность) формируются запросы к Booking с фиксированным временем выдачи/возврата `11:00`;
  - общее число запросов ограничено глобальным лимитом (`MAX_REQUESTS_PER_RUN`, по умолчанию 14).
- **Гибкий режим (набор дат)**:
  - пользователь задаёт до 6 отдельных дат старта (`pickupDates`) и набор часов выдачи (`pickupTimes`, в пределах 08:00–18:00);
  - для каждой комбинации `pickupDate × pickupTime` формируется отдельный запрос;
  - длительность аренды фиксирована `rentDays`.

Для всех режимов:

- из карточек результатов извлекаются:
  - поставщик
  - локация
  - модель
  - цена
- применяются фильтры по нужным поставщикам/локациям;
- для каждого окна выбираются минимальные цены и сохраняются результаты;
- на каждую локацию сохраняется только 1 самая дешёвая машина.

## API

### `POST /api/run`

Запускает поиск.

Тело:

```json
{
  "startDate": "2026-03-18",
  "endDate": "2026-03-20",
  "rentDays": 1
}
```

Ответ:

- `200` + `{ "ok": true }` при успешном завершении
- `500` + ошибка при проблемах запуска/выполнения

### `GET /api/results`

Возвращает содержимое `results.json`.

### `GET *`

Возвращает `public/index.html` (SPA fallback).

## UI-функции

- выбор дат и длительности аренды
- запуск нового поиска
- загрузка последних результатов
- сортировка и фильтрация карточек в интерфейсе

## Технические ограничения

- Сервер слушает только localhost (`127.0.0.1`), не предназначен для внешнего доступа.
- При повторном запуске предыдущий процесс поиска останавливается (`SIGTERM`).
- Если `results.json` отсутствует, API возвращает `404`.

## Зависимости

- runtime: `express`
- dev/runtime tools: `playwright`, `nodemon`

## Минимальный smoke-check

1. `npm run ui`
2. открыть ссылку из терминала
3. нажать «Запустить поиск»
4. убедиться, что после завершения обновились:
   - `results.json`
   - `results.csv`
