 # Booking Car Scout — Версионность

## Текущая версия спецификации

- `v1.4.0` от `2026-02-26`

 ## Политика версионирования

 - формат версии: `MAJOR.MINOR.PATCH`
   - `MAJOR` — несовместимые изменения логики/API
   - `MINOR` — новые функции без поломки совместимости
   - `PATCH` — исправления багов/стабильности без изменения контракта
 - для каждой версии фиксируются:
   - дата
   - короткий список изменений
   - статус (`planned` / `in-progress` / `done`)

## История версий (Changelog)

> В этом разделе фиксируются **изменения поведения и логики** сервиса. Детали визуального оформления клиентского UI сознательно не описываются.

### v1.4.0 — 2026-02-26 — done

- обычный режим поиска переехал на много-дневную модель: для каждой стартовой даты в окне перебираются длительности `rentDays..rentDays+3` с жёстким ограничением в 7 календарных дней и вписыванием в выбранное окно
- в обычном режиме время выдачи/возврата зафиксировано на `11:00`, тогда как гибкий режим по‑прежнему использует переданные из UI часы (`pickupTimes`)
- оценка количества job на сервере и раннер перестроены под новую схему: до 7 стартовых дат × до 4 длительностей, с глобальным лимитом в 14 запросов за запуск
- в UI блок «Результат» показывает фактический срок аренды глобального минимума, а карточки дополнены приблизительной ценой за сутки
- исправлена семантика длительности аренды в UI: расчёт дней и ограничения календаря синхронизированы с фактической моделью поиска (без ошибки `+1` дня)
- в выдаче добавлена группировка окон по длительности и улучшена навигация по итогам: «минимальная общая цена» и «минимальная цена за сутки»
- стабилизирован ввод `rentDays` с клавиатуры (корректная валидация/нормализация диапазона `1..7` без неожиданных автозамен)
- повышена устойчивость раннера к локализованной выдаче Booking: распознавание цен в форматах `€123` и `123€`, расширенные fallback для поставщика/локации и защитные таймауты чтения карточек

### v1.3.1 — 2026-02-25 — done

- в обычном режиме поиска календарь снова явно ограничивает доступный диапазон: после выбора даты начала подсвечиваются только допустимые даты окончания (от `rentDays` до максимального окна `7` дней), остальные будущие даты конца становятся некликабельными
- поведение календаря упрощено до одного месяца без изменения контракта по датам и окнам; выбор диапазона по-прежнему работает через клик по началу и концу
- добавлена возможность сбросить выбор дат простым повторным кликом по дате начала (как в состоянии выбора только начала, так и при уже выбранном полном диапазоне)
- терминологию вкладки поиска и блока итогового окна выровняли: «Календарь» заменён на «Поиск», «Анализ» — на «Результат» без изменения API

### v1.3.0 — 2026-02-25 — done

- расширена логика пресетов в гибком режиме: добавлены готовые наборы дат «все выходные» и «пятница + выходные» сразу на двух соседних месяцах, повторный клик по пресету снимает его выбор
- поведение панели результатов и блока анализа скорректировано: они отображаются только после получения свежих данных поиска, что исключает показ устаревшей выдачи при запуске нового прогона
- модель прогресса уточнена: при старте поиска выставляется базовый прогресс `5%`, а по завершении гарантированно достигается `100%`, что делает оценку статуса и ETA более предсказуемой
- стабилизирован запуск браузера из UI: процессы, запускаемые через `/api/run`, корректно поднимают Google Chrome/Chromium с отдельным профилем и явной настройкой окружения, устраняя падения вида `Script failed` без изменения контракта API

 ### v1.2.3 — 2026-02-24 — done

 - стабилизировано поведение гибкого поиска по датам: календарная сетка всегда формируется как фиксированное окно в 42 ячейки (6 недель), чтобы исключить артефакты в отдельных месяцах
 - устранены проблемы с обрезанием текстов и выбранных окон в гибком режиме (все выбранные окна и поясняющие тексты всегда доступны пользователю)

 ### v1.2.2 — 2026-02-24 — done

 - уточнена логика выделения диапазонов в гибком режиме: чётко разделены даты старта, конца и промежуточные дни окна
 - фильтр «Время выдачи» переведён на динамические значения, формируемые из фактических полей результатов (`time` / `pickupTime`), что корректно поддерживает произвольные часы из гибкого поиска
 - порядок действий в панели управления приведён к следующему: сначала чтение последнего результата, затем запуск нового поиска

 ### v1.2.1 — 2026-02-24 — done

 - стабилизирована работа «обычного» режима с выбором диапазона дат: синхронизация выбранных дат и автоматический переход между месяцами работают предсказуемо
 - исправлены граничные кейсы при расчёте доступныx окон для `rentDays = 6` и `7` дней

 ### v1.2.0 — 2026-02-24 — done

 - добавлены два режима работы поиска:
   - **Обычный режим** — поиск по непрерывному диапазону дат (`startDate`–`endDate`) с ограничением окна максимум 7 дней
   - **Гибкий режим** — поиск по набору отдельных дат старта (`pickupDates`) и двум часам выдачи (`pickupTimes`)
 - в гибком режиме:
   - поддерживается выбор до `6` дат старта (`pickupDates`)
   - реализованы пресеты для быстрого выбора дат (например, «все выходные», «все пятницы»)
   - добавлена передача двух пользовательских временных окон выдачи (`08:00..18:00`) через `pickupTimes`
 - в обычном режиме:
   - восстановлена логика окна поиска `1..7` дней независимо от `rentDays`
   - запрещён выбор прошедших дат
 - стабилизирован runtime:
   - отключён нестабильный headless-путь из-за регрессий
   - возвращён параллельный поиск по вкладкам браузера (по умолчанию `4`, параметр `PARALLEL_TABS`)
 - улучшена работа с капчей:
   - скрипт сигнализирует о необходимости ручной проверки (через события и `/api/progress`)
   - после успешного прохождения капчи поиск продолжается без перезапуска

 ### v1.1.3 — 2026-02-24 — done

 - текущий билд зафиксирован как рабочий baseline для дальнейших изменений
 - результат «самое дешёвое окно» стал навигационным объектом: можно перейти к соответствующему окну/времени в списке результатов
 - стабилизирован ввод `rentDays` с клавиатуры при сохранении ограничений `1..7`

 ### v1.1.2 — 2026-02-24 — done

 - ужесточено ограничение по количеству машин на локацию: сохраняется только 1 самая дешёвая машина вместо 2
 - цель изменения — ускорить прогон и упростить итоговую выдачу для анализа

 ### v1.1.1 — 2026-02-24 — done

 - подтверждён hotfix по кейсу пустой выдачи: окно `24–26` корректно даёт результат на `16:00`
 - стабилизирована логика детекции пустой выдачи (`cards-first`, консервативный `no-cars`)
 - добавлен best-effort путь после soft-timeout и ослабление supplier-фильтра, если UI-фильтр не применился
 - известное ограничение: в разреженных окнах (когда доступно только одно время) возможен увеличенный runtime

 ### v1.1.0 — 2026-02-21 — done

 - внедрены шаг 1 и шаг 2 recovery‑плана по логике дат и окон (без изменения контракта API)
 - добавлен серверный `GET /api/progress` для мониторинга выполнения поиска
 - в модель прогресса добавлены проценты и оценка оставшегося времени (ETA), рассчитываемые по завершённым job
 - зафиксированы рабочие варианты конфигурации (`R5a`, `R5c`), откатан неудачный (`R5b`) из‑за регрессии производительности

 ### v1.0.0 — 2026-02-21 — done

 - восстановлена базовая рабочая структура проекта (`set_location.js`, `server.js`, `public/index.html`)
 - описана архитектура, API и сценарии запуска
 - добавлен единый файл спецификации в корень проекта

