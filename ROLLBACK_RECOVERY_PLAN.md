# ROLLBACK Recovery Plan

## Контекст отката

Сегодняшние изменения были откатаны к рабочей базе, потому что в цепочке правок появились регрессии:
- деградация скорости прогонов;
- зависания на первых job (прогресс оставался на 0);
- пересоздание вкладок и нестабильный цикл обработки;
- рассинхрон между UI и фактическими результатами;
- частичная поломка серверной/фронтовой связки (пропажи файлов и ошибок `ENOENT`).

## Полный перечень откатанных изменений (сегодня)

Источник: история сегодняшней сессии [План отката и восстановление](0b2c5639-d0c8-4ab7-8ebd-eb3f85335c77).

### `set_location.js`

1. Изменение ограничений выдачи:
   - `MAX_PER_LOCATION` менялся на `1`.
2. Добавление runtime-конфигов:
   - `ENABLE_REQUEST_BLOCKING`, `HEADLESS`, `SLOW_MO`, `POOL_THROTTLE_MS`;
   - настройки таймингов (`WAIT_RESULTS_LOAD_MS`, `WAIT_FOR_RESULTS_MS`, timeout на captcha/job).
3. Блокировка сетевых запросов:
   - добавлялась `enableRequestBlocking(page)`;
   - вызывалась в начале `runOneJob(...)`;
   - потом логика блокировки перерабатывалась из-за ложных совпадений и подвисаний.
4. Изменения модели запуска браузера:
   - подключение `HEADLESS`/`SLOW_MO` в `launchPersistentContext(...)`;
   - добавление обработок ошибок запуска (`BROWSER_LAUNCH_FAILED`, catch на верхнем уровне).
5. Изменения алгоритма пула:
   - эксперименты с паузами между job и со стартовым stagger;
   - добавление/удаление таймаутов job и обёрток наподобие `withTimeout(...)`;
   - добавление/откат логики пересоздания вкладок при ошибках.
6. Изменения фильтрации/сортировки:
   - `applySupplierFilter` и `applySortPriceAsc` переводились на boolean-результаты;
   - добавлялись fallback-механизмы и диагностическое логирование.
7. Работа с результатами:
   - добавлялась принудительная перезапись пустых `results.json/results.csv`, чтобы не показывать устаревшие данные.
8. Обработка дат:
   - менялась логика расчёта/форматирования дат (локальная зона vs UTC), чтобы убрать сдвиги по дню.
9. Корректное завершение:
   - дорабатывалась обработка `SIGTERM`, чтобы дождаться закрытия контекста браузера перед выходом.

### `server.js`

1. API и режим запуска:
   - добавлялся `GET /api/progress`;
   - `POST /api/run` переводился в async-start режим (`202`) с поллингом прогресса;
   - затем поведение запуска частично возвращалось к базовой модели из-за нестабильности.
2. Управление параллельными запусками:
   - добавлялась отмена предыдущего поиска через `SIGTERM`;
   - добавлялась пауза перед новым запуском (например, ~2.5 сек) для освобождения профиля.
3. Обработка ошибок:
   - менялся формат возврата ошибок из `stderr` (очистка длинного технического вывода);
   - добавлялся возврат диагностических фрагментов в ответ API.
4. Расчёт параметров поиска:
   - менялась логика расчёта `horizon` (inclusive/exclusive, без `+1`).
5. Техническое восстановление:
   - файл `server.js` восстанавливался после пропажи в рабочем каталоге.

### `public/index.html`

1. Изменения формы:
   - переименование label в "Дата конца";
   - автоподстановка `endDate = startDate + 1 день`;
   - пересмотр ограничений окна дат (минимум/максимум в диапазоне 1..7 дней).
2. Прогресс и телеметрия:
   - добавлялись прогресс-бар, проценты, ETA;
   - добавлялся опрос `/api/progress` для отображения статуса.
3. UX при ошибках:
   - добавлялся вывод более подробных сообщений ошибки запуска вместо короткого `Script failed`.
4. Техническое восстановление:
   - `public/index.html` восстанавливался после пропажи (ошибка `ENOENT` на сервере).

## Почему эти изменения были откатаны

- Комбинация изменений в `set_location.js` и `server.js` изменила поведение рантайма сильнее, чем ожидалось.
- Часть оптимизаций давала нестабильность вместо ускорения (подвисания, повторные открытия вкладок).
- Изменения в контракте `/api/run` + прогрессе усиливали рассинхрон между UI и реальным состоянием процесса.
- В процессе экспериментов возникли инфраструктурные сбои (временная пропажа `server.js` и `public/index.html`), что потребовало полного возврата к базовой рабочей версии.

## Чеклист безопасного возврата изменений (по одному флагу)

Принцип: включать только один блок за раз, после каждого шага прогонять одинаковый smoke-test и фиксировать результат в заметке.

### Шаг 0. Базовая точка

- [ ] Зафиксировать baseline на рабочей версии (время полного прогона, число найденных вариантов, отсутствие ошибок в UI/сервере).
- [ ] Проверить, что `results.json` создаётся и соответствует текущему запуску (без "старых" данных).

### Шаг 1. Безопасные UI-правки (без изменения рантайма)

- [x] Вернуть только текстовые/визуальные правки в `public/index.html` (label, подписи, мелкие сообщения).
- [x] Проверка: кнопки работают, форма валидируется, запуск и загрузка результатов не изменились по времени/поведению.
- [ ] Критерий отката: любой новый JS-ошибки в браузере или блокирующее изменение UX.

Отчёт по шагу 1 (подтверждено пользователем):

- После внесения только UI-текстовых правок система работает стабильно.
- Поиск запускается и завершается корректно, без ухудшения времени.
- Регрессий в UX/валидации формы не обнаружено.

### Шаг 2. Даты и валидация диапазона

- [x] Вернуть правки расчёта окна дат (включая логику без `+1`, если подтверждена корректность).
- [x] Проверка: кейс `18 -> 20` даёт окно `2`, а в результатах нет сдвига дат на предыдущий день.
- [ ] Критерий отката: обнаружен сдвиг дат (UTC/local) или несоответствие UI и `results.json`.

Отчёт по шагу 2 (подтверждено пользователем):

- Ошибка с датами устранена.
- Логика диапазона и окон поиска работает корректно (в соответствии с моделью "дата конца аренды").
- Поиск по производительности и стабильности не ухудшился относительно baseline.

### Шаг 3. Серверный прогресс (`/api/progress`) без изменения модели запуска

- [x] Добавить `GET /api/progress`, но оставить `POST /api/run` в текущей стабильной модели.
- [x] Проверка: поллинг прогресса работает, но не влияет на запуск/завершение поиска.
- [x] Критерий отката: зависания, рост времени ответа API, рассинхрон done/total.

Отчёт по шагу 3:

- Серверный endpoint `/api/progress` добавлен и работает на стабильной модели `POST /api/run`.
- UI дополнен progress bar и ETA через фоновый polling, без изменения контракта завершения поиска.
- Поиск по-прежнему завершается в прежнем потоке: сначала выполнение скрипта, затем загрузка `results.json`.
- ETA не идеально точный в начале прогона, но после правки расчёта по завершённым job отображает существенно более реалистичный прогресс.
- Текущий билд признан рабочим и корректным для дальнейших шагов плана.

### Шаг 4. Улучшения завершения процесса и перезапуска

Статус шага: `optional / hardening` (выполнять только при наличии симптомов).

- [ ] Вернуть корректное закрытие браузера на `SIGTERM`.
- [ ] При необходимости вернуть паузу перед повторным запуском (как отдельный toggle).
- [ ] Проверка: 3 подряд перезапуска поиска не дают конфликта профиля и "залипших" процессов.
- [ ] Критерий отката: `BROWSER_LAUNCH_FAILED`, висящие процессы, повторные конфликты профиля.

Примечание:

- На текущем рабочем билде шаг 4 отложен, так как стабильность подтверждена пользователем.
- Возвращаться к шагу только при появлении симптомов: конфликты профиля, зависшие процессы, ошибки запуска после повторного старта.

### Шаг 5. Оптимизации `set_location.js` (строго по одной)

- [ ] Сначала вернуть только один параметр производительности (например, `POOL_THROTTLE_MS`).
- [ ] Отдельно включить/проверить блокировку запросов (`ENABLE_REQUEST_BLOCKING`) только с узкими правилами по hostname.
- [ ] Отдельно включить изменения фильтра/сортировки (boolean-результаты + fallback).
- [ ] Не объединять в один шаг: таймауты job, пересоздание вкладок, aggressive blocking.
- [ ] Критерий отката: прогресс застревает на 0, вкладки пересоздаются, время прогона растёт >20% от baseline.

### Шаг 6. Работа с пустой выдачей

- [ ] Вернуть принудительную перезапись пустых `results.json/results.csv`.
- [ ] Проверка: при нулевом результате UI явно показывает "нет данных", старые карточки не подмешиваются.
- [ ] Критерий отката: повреждение формата файлов или поломка чтения на фронте.

## Минимальный регрессионный smoke-test (обязателен после каждого шага)

- [ ] Окно 2 дня, 3 параллельные вкладки, запуск из UI.
- [ ] Проверка прогресса: `doneJobs` растёт с 0, ETA меняется, нет "вечного" ожидания.
- [ ] Проверка дат: даты в карточках совпадают с выбранным диапазоном (без сдвига на день назад).
- [ ] Проверка стабильности: 2 последовательных запуска без перезапуска сервера.
- [ ] Проверка артефактов: `results.json` и `results.csv` обновлены текущим запуском.

## Трекер повторного внедрения (под исполнение)

Статусы: `planned` -> `in-progress` -> `verified` (или `rolled-back`, если шаг не прошёл проверку).

| ID | Блок | Файлы | Toggle/идея | Статус | Дата | Комментарий |
|---|---|---|---|---|---|---|
| R0 | Baseline | `set_location.js`, `server.js`, `public/index.html` | Зафиксировать эталонные метрики (время, стабильность, объём выдачи) | planned | - | Стартовая контрольная точка |
| R1 | Безопасные UI-правки | `public/index.html` | Только тексты/label/мелкий UX без изменения рантайма | planned | - | Обязательный smoke-test после шага |
| R2 | Даты и диапазон | `public/index.html`, `server.js`, `set_location.js` | Логика окна без `+1`, проверка local date без UTC-сдвига | planned | - | Проверить кейс `18 -> 20` |
| R3 | Прогресс API | `server.js`, `public/index.html` | `GET /api/progress` без смены модели запуска `/api/run` | planned | - | Наблюдать `doneJobs/ETA` |
| R4 | Остановка/перезапуск | `set_location.js`, `server.js` | Корректный `SIGTERM`, опциональная пауза перед новым запуском | planned | - | Проверить 3 подряд запуска |
| R5a | Оптимизация пула | `set_location.js` | Только `POOL_THROTTLE_MS` (или один параметр за шаг) | verified | 2026-02-21 | Рабочее решение, стабильность сохранена |
| R5b | Блокировка запросов | `set_location.js` | `ENABLE_REQUEST_BLOCKING` только с whitelist/hostname-правилами | rolled-back | 2026-02-21 | Регресс: ~176s/job, 0 результатов, нестабильность (`page/context closed`) |
| R5c | Фильтр/сортировка | `set_location.js` | Boolean-результаты + fallback + минимальный лог | verified | 2026-02-21 | Время сопоставимо с R5a, стабильность сохранена |
| R6 | Пустая выдача | `set_location.js` | Явная перезапись пустых `results.json/results.csv` | in-progress | 2026-02-21 | Добавлена перезапись пустых результатов |

### Журнал проверок (обновлять после каждого шага)

| Дата | ID шага | Smoke-test | Итог | Наблюдения |
|---|---|---|---|---|
| 2026-02-21 | R5a | OK | verified | Время прогона ~58.5s, стабильность сохранена |
| 2026-02-21 | R5b | FAIL | rolled-back | Сильная деградация (первый job ~176s), итог 0 результатов, лог `page.goto: Target page/context/browser has been closed` |
| 2026-02-21 | R5c | OK | verified | Время на уровне R5a, регрессий по стабильности не выявлено |
| 2026-02-21 | Hotfix | WIP | in-progress | Добавлен fail-fast при капче в UI-режиме (таймаут 90с + skip job), чтобы исключить зависание на 75% |
| 2026-02-24 | Hotfix | WIP | in-progress | Исправлен приоритет в `waitForResultsOrNoCars`: сначала проверка карточек, затем `No cars available`; добавлен лог причины пропуска окна |
| 2026-02-24 | Hotfix | OK | verified | Кейс `24-26` исправлен (результат на 16:00 отображается). В отдельных разреженных окнах время поиска всё ещё может быть увеличенным |
